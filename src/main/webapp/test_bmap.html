<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
		body, html{width: 100%;height: 100%;margin:0;font-family:"微软雅黑";}
		#map_div{height:100%;width:80%;float:left;}
		#allmap{height:95%;width:100%;}
		#dorderlist{height:100%;width:20%;float:right;overflow-y:auto;font-size:13px;}
		#r-result{width:100%;}
		.dcart_cls{border:1px solid #dfdfdf;padding:5px;float:left;cursor:pointer;}
	</style>
	<script src="resources/jquery/jquery-1.8.1.min.js"></script>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=m71MZg0PcQOWUVdiMjG19hyZ"></script>
	<title>派车单自动生成</title>
	<script>
		var map;
		var centerPoint;
		var dcart_routes = [];
		var routePolicy = [BMAP_DRIVING_POLICY_LEAST_TIME,BMAP_DRIVING_POLICY_LEAST_DISTANCE,BMAP_DRIVING_POLICY_AVOID_HIGHWAYS];
		var dcartsee = function(i){
			var wayps = dcart_routes[i].wayps;
			var markers = dcart_routes[i].markers;
			var driving = dcart_routes[i].driving;
			var show = dcart_routes[i].show;
			if(!driving){
				driving = new BMap.DrivingRoute(map, {
					renderOptions:{map: map, autoViewport: false},
					policy:routePolicy[0],
					onSearchComplete:function(results){
						if (driving.getStatus() != BMAP_STATUS_SUCCESS){
							return ;
						}
						console.log(results);
						var plan = results.getPlan(0);
						//setTimeout(function(){alert("路线规划："+plan.getDuration(true)+","+plan.getDistance(true))},"1000");
						$('#dcart_'+i).html($('#dcart_'+i).html()+"<br>路线规划："+plan.getDuration(true)+","+plan.getDistance(true));
						driving.setSearchCompleteCallback(null);
					}	
				});	
				dcart_routes[i].driving = driving;
			}
			if(show){
				$.each(markers,function(a,marker){
					marker.setAnimation();	
				});
				driving.clearResults();
				$('#dcart_'+i).css("background-color","");	
			}else{
				driving.search(centerPoint, wayps[wayps.length-1],{waypoints:wayps});
				$.each(markers,function(a,marker){
					marker.setAnimation(BMAP_ANIMATION_BOUNCE);	
				});
				$('#dcart_'+i).css("background-color","#FFFF00");
			}
			dcart_routes[i].show = !show;
		}

		var dcartseeclear = function(){
			$.each(dcart_routes,function(a,dcart_route){
				if(dcart_route.driving){
					dcart_route.driving.clearResults();
				}
			});
		}
		
		$(function(){
			map = new BMap.Map("allmap");
			centerPoint = new BMap.Point(121.47114671675,31.377180618456);
			var centerIcon = new BMap.Icon("http://developer.baidu.com/map/jsdemo/img/fox.gif", new BMap.Size(300,157));
			map.addOverlay(new BMap.Marker(centerPoint,{icon:centerIcon}));
			map.centerAndZoom(centerPoint, 12);
			$.ajax({
	    		url:'/test/allocate',
	    		data:{'storageId':1},
	    		success:function(data){
	    			if(data.s==0){
	    				return ;
	    			}
	    			if(!data.dCartList){
	    				$("#dorderlist").html('无派车单'); 
	    				return ;
	    			}
	    			var list_content = $("#dorderlist").html();
	    			$.each(data.dCartList,function(i,dcart){
	    				list_content += '<div id="dcart_'+i+'" style="border:1px solid #dfdfdf;padding:5px;cursor:pointer;" onclick="dcartsee('+i+');">'+'第'+(i+1)+'张派车单'+'</div>'
	    				dcart_routes[i] = {wayps:[],markers:[],show:false};
	    				$.each(dcart,function(j,dorder){
	    					if(dorder.degrees){
								var point = new BMap.Point(dorder.lng,dorder.lat);
								var marker = new BMap.Marker(point); 
								//marker.setLabel(new BMap.Label(dorder.id+'.'+dorder.receiverAddress,{offset:new BMap.Size(20,-10)}));
								var infoWindow = new BMap.InfoWindow('角度：'+dorder.degrees+'<br>距离：'+dorder.distance+'米<br>订单：'+dorder.orderNo+'<br>地址：'+dorder.receiverAddress, {}); 
								marker.addEventListener("click", function(){
									map.openInfoWindow(infoWindow,point);
								});
								map.addOverlay(marker);
		    					dcart_routes[i].wayps.push(point);
		    					dcart_routes[i].markers.push(marker);
		    				}
	    				});
					});
					$("#dorderlist").html(list_content);
	    		}
	    	});
		})
	</script>  
</head>
<body>
	<div id="map_div">
		<div id="dcartlist" style="height:5%;display:none;">
			<div style="float:left;">	
				第<input id="dart_num" type="text" style="width:50px;"/>张派车单
				<select id="route_policy">
					<option value="0">最少时间</option>
					<option value="1">最短距离</option>
					<option value="2">避开高速</option>
				</select>
				<input type="button" value="查询" onclick="dcartsee();"/>	
				<input type="button" value="清空" onclick="dcartseeclear();"/>
			</div>
			<div id="route_content" style="margin-left:20px;float:left;"></div>	
		</div>
		<div id="allmap"></div>
	</div>
 	<div id="dorderlist">
 		<form id="form1" action="/test/allocate/export" style="margin-left:20px;height:30px;">
	 		<input type="hidden" name="storageId" value="1"/>
			派车单明细：<input type="submit" class="pc-dc" value="导出"/>
		</form>
 	</div>
</body>
</html>
